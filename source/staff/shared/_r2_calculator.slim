= javascript_include_tag 'https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.3.14/angular.js'
javascript:
  var app = angular.module('app', []);

  app.controller('Prototype', ['$scope', function ($scope) {

    // $scope.children = 0
    $scope.fee = 410;
    $scope.resultShown = false;

    $scope.thresholds = function () {
      var couple = $scope.couple;

      var lowThreshold = 1085 + (245 * $scope.children)
      if (couple) {
        lowThreshold = lowThreshold + 160;
      }

      var highThreshold = lowThreshold + Math.min(4000, $scope.fee * 2)

      var thresholds = {
        low: lowThreshold,
        high: highThreshold
      }

      return thresholds;
    }

    $scope.incr = function (number) {
      $scope.children = $scope.children + number;
      if ($scope.children < 0) {
        $scope.children = 0;
      }
    }

    $scope.fullRemission = function () {
      return ($scope.monthlyIncome < $scope.thresholds().low);
    }

    $scope.partialRemission = function () {
      return ($scope.monthlyIncome >= $scope.thresholds().low && $scope.monthlyIncome < $scope.thresholds().high);
    }

    $scope.coupleName = function () {
      if ($scope.couple) {
        return "person who is part of a couple";
      } else {
        return "single person";
      }
    }

    $scope.feePayable = function () {
      if (this.fullRemission()) {
        return 0;
      } else if (this.partialRemission()) {
        var incomeAboveThreshold = $scope.monthlyIncome - this.thresholds().low;
        return Math.min(incomeAboveThreshold / 2, $scope.fee);
      } else {
        return $scope.fee;
      }
    }

    $scope.feeRemitted = function () {
      return $scope.fee - this.feePayable();
    }

    $scope.showResult = function () {
      if ($scope.monthlyIncome) {
        $scope.resultShown = true;
      } else {
        $scope.resultShown = false;
      }

    }

  }]);

#canvas ng-controller="Prototype"
  .row
    .small-12.medium-3.large-3.columns
      label for='claim_number'
        | Fee
      .small-2.medium-2.large-3.columns style="padding:0px;"
        span.prefix£
      .small-10.medium-10.large-9.columns style="padding:0px;"
        input type="number" ng-model="fee"
 
  .row
    .small-12.medium-6.large-5.columns
      label for='couple'
        | Part of a couple?
        .switch.radius
            input id="couple" type="checkbox" name="couple" ng-model="couple"
            label for='couple' Part of a couple?

  .row
    .small-12.medium-6.large-5.columns
      label.inline for='couple' Number of children
    .columns.small-6 ng-init="children = 0"
      a class="button secondary tiny no_selection" ng-click="incr(-1)" -
      strong style="padding: 0 10px;" {{ children }}
      a class="button secondary tiny no_selection" ng-click="incr(1)" +

  .row
    .small-12.medium-3.large-4.columns
      label for='couple'
        | Gross monthly income
      .small-2.medium-2.large-2.columns style="padding:0px;"
        span.prefix £
      .small-8.medium-7.large-7.columns style="padding:0px;"
        input type="number" ng-model="monthlyIncome" ng-blur="showResult()"
      .small-2.medium-3.large-3.columns style="padding:0px;"
        span.postfix
          a Next

  .row
    .columns.small-12.medium-12.large-12 ng-show='resultShown'
      p
        |Calculation for
        strong
          |&nbsp;{{ coupleName() }}
        |, with&nbsp;
        strong
          |{{ children }} children
        |, and gross&nbsp;
        strong monthly income of £{{ monthlyIncome }}
        |:
      ul
        li Fee remitted: {{ feeRemitted() | currency:"£" }}
        li Fee payable: {{ feePayable() | currency:"£" }}

  .columns.small-12.medium-12.large-12.calc
    ul
      li.full ng-class="{selected: fullRemission() }"
        span.result Full remission
        |&nbsp;if income is below&nbsp;
        strong £{{ thresholds().low }}
        |.
      li.partial ng-class="{selected: partialRemission() }"
        span.result Part remission
        |&nbsp;if income is between&nbsp;
        strong £{{ thresholds().low }}
        |&nbsp;and&nbsp;
        strong £{{ thresholds().high }}
        |.
      li.none ng-class="{selected: monthlyIncome >= thresholds().high }"
        span.result No remission
        |&nbsp;if income is above&nbsp;
        strong £{{ thresholds().high }}
        |.
